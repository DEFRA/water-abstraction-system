{% extends 'layout.njk' %}

{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/pagination/macro.njk" import govukPagination %}
{% from "govuk/components/tag/macro.njk" import govukTag %}

{% from "macros/return-status-tag.njk" import statusTag %}

{% macro resultCard(col1, col2, col3) %}
  <!--result card-->
  <hr class="govuk-section-break govuk-section-break--visible">
  <div class="govuk-grid-row govuk-!-margin-top-0">
    <dl class="govuk-body govuk-!-margin-0">
      <div class="govuk-grid-column-one-third govuk-body govuk-!-margin-bottom-2 govuk-!-margin-top-2 ">
        {{ col1 | safe }}
      </div>
      <div class="govuk-grid-column-one-third govuk-body govuk-!-margin-bottom-2 govuk-!-margin-top-2">
        {{ col2 | safe }}
      </div>
      <div class="govuk-grid-column-one-third govuk-body govuk-!-margin-bottom-2 govuk-!-margin-top-2">
        {{ col3 | safe }}
      </div>
    </dl>
  </div>
  <hr class="govuk-section-break govuk-section-break--visible">
{% endmacro %}

{% macro resultCardTerm(text) %}<dt class="govuk-!-margin-right-3 govuk-!-display-inline-block govuk-!-font-size-16">{{ text | safe }}</dt>{% endmacro %}
{% macro resultCardDetail(text) %}<dd class="govuk-!-display-inline-block govuk-!-margin-left-0 govuk-!-font-size-16">{{ text | safe }}</dd>{% endmacro %}
{% macro resultCardLargeDetail(text) %}<dd class="govuk-!-display-inline-block govuk-!-margin-left-0">{{ text | safe }}</dd>{% endmacro %}
{% macro resultCardLink(text, href) %}<a class="govuk-link govuk-link--no-underline govuk-link--no-visited-state" href="{{ href }}">{{ text }}<a/>{% endmacro %}

{% macro licenceResultCard(licence) %}
  {% set link = resultCardLink(licence.licenceRef, '/system/licences/' + licence.id + '/summary') %}
  {% set endDateContent %}{{ licence.licenceEndDate }} {{ govukTag({ text: licence.licenceEndedText, classes: 'govuk-tag--grey' }) if licence.licenceEndedText }}{% endset %}
  {% set col1 %}
    {{ resultCardTerm('Licence:') }}{{ resultCardLargeDetail(link) | safe }}
  {% endset %}
  {% set col2 %}
    {{ resultCardTerm('Licence holder:') }}{{ resultCardDetail(licence.licenceHolderName) }}
  {% endset %}
  {% set col3 %}
    {{ resultCardTerm('End date:') }}{{ resultCardDetail(endDateContent) | safe }}
  {% endset %}
  {{ resultCard(col1, col2, col3 )}}
{% endmacro %}

{% macro monitoringStationResultCard(monitoringStation) %}
  {% set link = resultCardLink(monitoringStation.label, '/system/monitoring-stations/' + monitoringStation.id) %}
  {% set col1 %}
    {{ resultCardTerm('Monitoring station:') }}{{ resultCardLargeDetail(link) | safe }}
  {% endset %}
  {% set col2 %}
    {{ resultCardTerm('Station reference:') }}{{ resultCardDetail(monitoringStation.stationReference) }}
    <br/>
    {{ resultCardTerm('WISKI ID:') }}{{ resultCardDetail(monitoringStation.wiskiId) }}
  {% endset %}
  {% set col3 %}
    {{ resultCardTerm('Catchment:') }}{{ resultCardDetail(monitoringStation.catchmentName) }}
    <br/>
    {{ resultCardTerm('River:') }}{{ resultCardDetail(monitoringStation.riverName) }}
  {% endset %}
  {{ resultCard(col1, col2, col3 )}}
{% endmacro %}

{% macro returnLogResultCard(returnLog) %}
  {% set link = resultCardLink(returnLog.returnReference, '/system/return-logs?id=' + returnLog.id) %}
  {% set endDateContent %}{{ returnLog.endDate }} {{ statusTag(returnLog.statusText, true) if returnLog.statusText }}{% endset %}
  {% set statusTag %}{{ statusTag(returnLog.statusText, true) if returnLog.statusText }}{% endset %}
  {% set col1 %}
    {{ resultCardTerm('Return reference:') }}{{ resultCardLargeDetail(link) | safe }}
  {% endset %}
  {% set col2 %}
    {{ resultCardTerm('Licence:') }}{{ resultCardDetail(returnLog.licenceRef) }}
    <br/>
    {{ resultCardTerm('Region:') }}{{ resultCardDetail(returnLog.regionDisplayName) }}
  {% endset %}
  {% set col3 %}
    {{ resultCardTerm('End date:') }}{{ resultCardDetail(endDateContent) | safe }}
  {% endset %}
  {{ resultCard(col1, col2, col3 )}}
{% endmacro %}

{% block pageContent %}

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      <h1 class="govuk-heading-xl"> {{ pageTitle }}</h1>

      <form method="post">
        <input type="hidden" name="wrlsCrumb" value="{{wrlsCrumb}}"/>

        <div class="govuk-form-group {{ 'govuk-form-group--error' if error.query }}">
          <label class="govuk-label" for="query">
            Enter a licence number, customer name, returns ID, registered email address or monitoring station
          </label>

          {% if error.query %}
          <p id="query-error" class="govuk-error-message">
            <span class="govuk-visually-hidden">Error:</span> {{ error.query.text }}
          </p>
          {% endif %}
          <input class="govuk-input govuk-!-width-one-half govuk-!-display-inline-block" id="query" name="query" type="text" value="{{ query }}" {{ 'aria-describedby="query-hint query-error"' if error.query }}>

          {{ govukButton({
            classes: 'govuk-!-display-inline-block govuk-!-padding-right-6 govuk-!-padding-left-6',
            text: "Search", preventDoubleClick: true
          }) }}
        </div>
      </form>
    </div>
  </div>

  {% if showResults %}
    {% if noResults %}
      <div class="govuk-grid-row govuk-!-margin-top-9">
        <div class="govuk-grid-column-full">
          <p>No results found.</p>
        </div>
      </div>
    {% else %}
      {% if showExactResults %}
        <h3 class="govuk-heading-m">Exact matches</h3>

        <hr class="govuk-section-break govuk-section-break--visible">

        {% if exactMatches.monitoringStations %}
          {% for monitoringStation in exactMatches.monitoringStations %}
            {{ monitoringStationResultCard(monitoringStation) }}
          {% endfor %}
        {% endif %}

        {% if exactMatches.returnLogs %}
          {% for returnLog in exactMatches.returnLogs %}
            {{ returnLogResultCard(returnLog) }}
          {% endfor %}
        {% endif %}

        {% if exactMatches.licences %}
          {% for licence in exactMatches.licences %}
            {{ licenceResultCard(licence) }}
          {% endfor %}
        {% endif %}

        <hr class="govuk-section-break govuk-section-break--visible">

        <div class="govuk-grid-row govuk-!-margin-top-9">
          <div class="govuk-grid-column-full">
            <p></p>
          </div>
        </div>

      {% endif %}

      <h3 class="govuk-heading-m">Partial matches</h3>

      {% if noPartialResults %}
        <div class="govuk-grid-row govuk-!-margin-top-9">
          <div class="govuk-grid-column-full">
            <p>No partial matches</p>
          </div>
        </div>
      {% else %}
        <hr class="govuk-section-break govuk-section-break--visible">

        {% if partialMatches.monitoringStations %}
          {% for monitoringStation in partialMatches.monitoringStations %}
            {{ monitoringStationResultCard(monitoringStation) }}
          {% endfor %}
        {% endif %}

        {% if partialMatches.returnLogs %}
          {% for returnLog in partialMatches.returnLogs %}
            {{ returnLogResultCard(returnLog) }}
          {% endfor %}
        {% endif %}

        {% if partialMatches.licences %}
          {% for licence in partialMatches.licences %}
            {{ licenceResultCard(licence) }}
          {% endfor %}
        {% endif %}

        <hr class="govuk-section-break govuk-section-break--visible">

      {% endif %}

      {% if pagination.numberOfPages > 1 %}
        <div class="govuk-grid-row govuk-!-margin-top-9">
          <div class="govuk-grid-column-full">
            {{ govukPagination(pagination.component) }}
          </div>
        </div>
      {% endif %}

    {% endif %}
  {% endif %}

{% endblock %}
