{% extends 'layout.njk' %}

{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/details/macro.njk" import govukDetails %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/pagination/macro.njk" import govukPagination %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% from "govuk/components/tag/macro.njk" import govukTag %}

{% from "macros/return-status-tag.njk" import statusTag %}

{% set exactMatchParagraph %}<p class="govuk-body-s govuk-!-margin-bottom-0">Exact match</p>{% endset %}

{% macro resultCard(col1, col2, col3) %}
  <!--result card-->
  <hr class="govuk-section-break govuk-section-break--visible">
  <div class="govuk-grid-row govuk-!-margin-top-0">
    <dl class="govuk-body govuk-!-margin-0">
      <div class="govuk-grid-column-one-third govuk-body govuk-!-margin-bottom-2 govuk-!-margin-top-2 ">
        {{ col1 | safe }}
      </div>
      <div class="govuk-grid-column-one-third govuk-body govuk-!-margin-bottom-2 govuk-!-margin-top-2">
        {{ col2 | safe }}
      </div>
      <div class="govuk-grid-column-one-third govuk-body govuk-!-margin-bottom-2 govuk-!-margin-top-2">
        {{ col3 | safe }}
      </div>
    </dl>
  </div>
  <hr class="govuk-section-break govuk-section-break--visible">
{% endmacro %}

{% macro resultCardTerm(text) %}<dt class="govuk-!-margin-right-3 govuk-!-display-inline-block govuk-!-font-size-16">{{ text | safe }}</dt>{% endmacro %}
{% macro resultCardLargeTerm(text) %}<dt class="govuk-!-margin-right-3 govuk-!-display-inline-block">{{ text | safe }}</dt>{% endmacro %}
{% macro resultCardDetail(text) %}<dd class="govuk-!-display-inline-block govuk-!-margin-left-0 govuk-!-font-size-16">{{ text | safe }}</dd>{% endmacro %}
{% macro resultCardLargeDetail(text) %}<dd class="govuk-!-display-inline-block govuk-!-margin-left-0">{{ text | safe }}</dd>{% endmacro %}
{% macro resultCardLink(text, href) %}<a class="govuk-link govuk-link--no-underline govuk-link--no-visited-state" href="{{ href }}">{{ text }}</a>{% endmacro %}

{% macro licenceResultCard(licence, exactMatch) %}
  {% set link = resultCardLink(licence.licenceRef, '/system/licences/' + licence.id + '/summary') %}
  {% set endDateContent %}{{ licence.licenceEndDate }} {{ govukTag({ text: licence.licenceEndedText, classes: 'govuk-tag--grey' }) if licence.licenceEndedText }}{% endset %}
  {% set col1 %}
    {{ resultCardLargeTerm('Licence:') }}{{ resultCardLargeDetail(link) | safe }}{{ exactMatchParagraph | safe if exactMatch }}
  {% endset %}
  {% set col2 %}
    {{ resultCardTerm('Licence holder:') }}{{ resultCardDetail(licence.licenceHolderName) }}
  {% endset %}
  {% set col3 %}
    {{ resultCardTerm('End date:') }}{{ resultCardDetail(endDateContent) | safe }}
  {% endset %}
  {{ resultCard(col1, col2, col3) }}
{% endmacro %}

{% macro monitoringStationResultCard(monitoringStation, exactMatch) %}
  {% set link = resultCardLink(monitoringStation.label, '/system/monitoring-stations/' + monitoringStation.id) %}
  {% set col1 %}
    {{ resultCardLargeTerm('Monitoring station:') }}{{ resultCardLargeDetail(link) | safe }}{{ exactMatchParagraph | safe if exactMatch }}
  {% endset %}
  {% set col2 %}
    {{ resultCardTerm('River:') }}{{ resultCardDetail(monitoringStation.riverName) }}
  {% endset %}
  {% set col3 %}
    {{ resultCardTerm('Grid reference:') }}{{ resultCardDetail(monitoringStation.gridReference) }}
  {% endset %}
  {{ resultCard(col1, col2, col3 )}}
{% endmacro %}

{% macro returnLogResultCard(returnLog, exactMatch) %}
  {% set link = resultCardLink(returnLog.returnReference, '/system/return-logs?id=' + returnLog.id) %}
  {% set licenceLink = resultCardLink(returnLog.licenceRef, '/system/licences/' + returnLog.licenceId + '/returns') %}
  {% set endDateContent %}{{ returnLog.endDate }} {{ statusTag(returnLog.statusText, true) if returnLog.statusText }}{% endset %}
  {% set col1 %}
    {{ resultCardLargeTerm('Return reference:') }}{{ resultCardLargeDetail(link) | safe }}{{ exactMatchParagraph | safe if exactMatch }}
  {% endset %}
  {% set col2 %}
    {{ resultCardTerm('Licence returns:') }}{{ resultCardDetail(licenceLink) | safe }}
  {% endset %}
  {% set col3 %}
    {{ resultCardTerm('End date:') }}{{ resultCardDetail(endDateContent) | safe }}
  {% endset %}
  {{ resultCard(col1, col2, col3 )}}
{% endmacro %}

{% set filterContent %}
  <h2 class="govuk-heading-m govuk-!-margin-bottom-5">Filter matches by</h2>

  {{ govukRadios({
    classes: "govuk-radios--small",
    name: "resultType",
    fieldset: {
      legend: {
        text: "Match type",
        isPageHeading: false,
        classes: "govuk-fieldset__legend--s"
      }
    },
    items: [
      {
        value: "licence",
        text: "Licences",
        checked: resultType === 'licence'
      },
      {
        value: "monitoringStation",
        text: "Monitoring stations",
        checked: resultType === 'monitoringStation'
      },
      {
        value: "returnLog",
        text: "Return logs",
        checked: resultType === 'returnLog'
      }
    ]
  }) }}

  <div class="govuk-button-group">
    {{ govukButton({
      preventDoubleClick: true,
      text: "Apply filter"
    }) }}

    {{ govukButton({
      classes: "govuk-button--secondary",
      name: "clearFilter",
      preventDoubleClick: true,
      text: "Clear filter",
      value: 'reset'
    }) }}
  </div>
{% endset %}

{% block pageContent %}

  <div class="govuk-grid-row govuk-!-margin-top-9">
    <div class="govuk-grid-column-full">
      <h1 class="govuk-heading-xl govuk-!-margin-bottom-6">
        {{ pageTitle }}
        <span class="govuk-caption-l">{{ pageTitleCaption }}</span>
      </h1>

      <form method="post">
        <input type="hidden" name="wrlsCrumb" value="{{ wrlsCrumb }}"/>

        <div class="govuk-form-group {{ 'govuk-form-group--error' if error.query }}">
          <label class="govuk-label" for="query">
            Enter a licence number, customer name, returns ID, registered email address or monitoring station
          </label>

          {% if error.query %}
          <p id="query-error" class="govuk-error-message">
            <span class="govuk-visually-hidden">Error:</span> {{ error.query.text }}
          </p>
          {% endif %}
          <input class="govuk-input govuk-!-width-one-half govuk-!-display-inline-block" id="query" name="query" type="text" value="{{ query }}" {{ 'aria-describedby="query-hint query-error"' if error.query }}>

          {{ govukButton({
            classes: 'govuk-!-display-inline-block govuk-!-padding-right-6 govuk-!-padding-left-6',
            text: "Search", preventDoubleClick: true
          }) }}

          {{ govukDetails({
            classes: "govuk-!-margin-bottom-2",
            html: filterContent,
            open: resultType,
            summaryText: "Filter matches"
          }) }}

          {% if showResults %}
            <p class="govuk-body">Showing {{ resultTypeText }}</p>
          {% endif %}
        </div>
      </form>
    </div>
  </div>

  {% if showResults %}
    {% if noResults %}
      <div class="govuk-grid-row govuk-!-margin-top-9">
        <div class="govuk-grid-column-full">
          <p>No results found.</p>
        </div>
      </div>
    {% else %}
      <hr class="govuk-section-break govuk-section-break--visible">

      {% if showExactResults %}
        {% if exactMatches.licences %}
          {% for licence in exactMatches.licences %}
            {{ licenceResultCard(licence, true) }}
          {% endfor %}
        {% endif %}

        {% if exactMatches.monitoringStations %}
          {% for monitoringStation in exactMatches.monitoringStations %}
            {{ monitoringStationResultCard(monitoringStation, true) }}
          {% endfor %}
        {% endif %}

        {% if exactMatches.returnLogs %}
          {% for returnLog in exactMatches.returnLogs %}
            {{ returnLogResultCard(returnLog, true) }}
          {% endfor %}
        {% endif %}
      {% endif %}

      {% if not noPartialResults %}
        {% if partialMatches.licences %}
          {% for licence in partialMatches.licences %}
            {{ licenceResultCard(licence) }}
          {% endfor %}
        {% endif %}

        {% if partialMatches.monitoringStations %}
          {% for monitoringStation in partialMatches.monitoringStations %}
            {{ monitoringStationResultCard(monitoringStation) }}
          {% endfor %}
        {% endif %}

        {% if partialMatches.returnLogs %}
          {% for returnLog in partialMatches.returnLogs %}
            {{ returnLogResultCard(returnLog) }}
          {% endfor %}
        {% endif %}
      {% endif %}

      <hr class="govuk-section-break govuk-section-break--visible">

      {% if pagination.numberOfPages > 1 %}
        <div class="govuk-grid-row govuk-!-margin-top-9">
          <div class="govuk-grid-column-full">
            {{ govukPagination(pagination.component) }}
          </div>
        </div>
      {% endif %}

    {% endif %}
  {% endif %}

{% endblock %}
