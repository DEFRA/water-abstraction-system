{% extends 'layout.njk' %}

{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/details/macro.njk" import govukDetails %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/pagination/macro.njk" import govukPagination %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% from "govuk/components/tag/macro.njk" import govukTag %}

{% from "macros/return-status-tag.njk" import statusTag as returnStatusTag %}

{% macro licenceStatusTag(text) %}{{ govukTag({ text: text, classes: 'govuk-tag--grey' }) }}{% endmacro %}

{% set filterContent %}
  <h2 class="govuk-heading-m govuk-!-margin-bottom-5">Filter matches by</h2>

  {{ govukRadios({
    classes: "govuk-radios--small",
    name: "resultType",
    fieldset: {
      legend: {
        text: "Match type",
        isPageHeading: false,
        classes: "govuk-fieldset__legend--s"
      }
    },
    items: [
      {
        value: "licence",
        text: "Licences",
        checked: resultType === 'licence'
      },
      {
        value: "monitoringStation",
        text: "Monitoring stations",
        checked: resultType === 'monitoringStation'
      },
      {
        value: "returnLog",
        text: "Return logs",
        checked: resultType === 'returnLog'
      },
      {
        value: "user",
        text: "Users",
        checked: resultType === 'user'
      }
    ]
  }) }}

  <div class="govuk-button-group">
    {{ govukButton({
      preventDoubleClick: true,
      text: "Apply filter"
    }) }}

    {{ govukButton({
      classes: "govuk-button--secondary",
      name: "clearFilter",
      preventDoubleClick: true,
      text: "Clear filter",
      value: 'reset'
    }) }}
  </div>
{% endset %}

{% block pageContent %}

  <div class="govuk-grid-row govuk-!-margin-top-9">
    <div class="govuk-grid-column-full">
      <h1 class="govuk-heading-xl govuk-!-margin-bottom-6">
        {{ pageTitle }}
        <span class="govuk-caption-l">{{ pageTitleCaption }}</span>
      </h1>

      <form method="post">
        <input type="hidden" name="wrlsCrumb" value="{{ wrlsCrumb }}"/>

        <div class="govuk-form-group {{ 'govuk-form-group--error' if error.query }}">
          <label class="govuk-label" for="query">
            Enter a licence number, customer name, returns ID, registered email address or monitoring station
          </label>

          {% if error.query %}
          <p id="query-error" class="govuk-error-message">
            <span class="govuk-visually-hidden">Error:</span> {{ error.query.text }}
          </p>
          {% endif %}
          <input class="govuk-input govuk-!-width-one-half govuk-!-display-inline-block" id="query" name="query" type="text" value="{{ query }}" {{ 'aria-describedby="query-hint query-error"' if error.query }}>

          {{ govukButton({
            classes: 'govuk-!-display-inline-block govuk-!-padding-right-6 govuk-!-padding-left-6',
            text: "Search", preventDoubleClick: true
          }) }}

          {{ govukDetails({
            classes: "govuk-!-margin-bottom-2",
            html: filterContent,
            open: resultType,
            summaryText: "Filter matches"
          }) }}

          {% if showResults %}
            <p class="govuk-body">Showing {{ resultTypeText }}</p>
          {% endif %}
        </div>
      </form>
    </div>
  </div>

  {% if showResults %}
    {% if noResults %}
      <div class="govuk-grid-row govuk-!-margin-top-9">
        <div class="govuk-grid-column-full">
          <p>No results found.</p>
        </div>
      </div>
    {% else %}
      <hr class="searchresult-separator">

      {% if showExactResults %}
        {% if exactMatches.licences %}
          {% for licence in exactMatches.licences %}
            <hr class="searchresult-separator">
            <div class="searchresult-row">
              <dl class="searchresult-list">
                <div class="searchresult-column">
                  <dt class="searchresult-term-l">Licence:</dt><dd class="searchresult-detail-l"><a class="searchresult-link" href="/system/licences/{{ licence.id }}/summary">{{ licence.licenceRef }}</a></dd><p class="govuk-body-s govuk-!-margin-bottom-0">Exact match</p>
                </div>
                <div class="searchresult-column">
                  <dt class="searchresult-term">Licence holder:</dt><dd class="searchresult-detail">{{ licence.licenceHolderName }}</dd>
                </div>
                <div class="searchresult-column">
                  <dt class="searchresult-term">End date:</dt><dd class="searchresult-detail">{{ licence.licenceEndDate }} {{ licenceStatusTag(licence.licenceEndedText) if licence.licenceEndedText }}</dd>
                </div>
              </dl>
            </div>
            <hr class="searchresult-separator">
          {% endfor %}
        {% endif %}

        {% if exactMatches.monitoringStations %}
          {% for monitoringStation in exactMatches.monitoringStations %}
            <hr class="searchresult-separator">
            <div class="searchresult-row">
              <dl class="searchresult-list">
                <div class="searchresult-column">
                  <dt class="searchresult-term-l">Monitoring station:</dt><dd class="searchresult-detail-l"><a class="searchresult-link" href="/system/monitoring-stations/{{ monitoringStation.id }}">{{ monitoringStation.label }}</a></dd><p class="govuk-body-s govuk-!-margin-bottom-0">Exact match</p>
                </div>
                <div class="searchresult-column">
                  <dt class="searchresult-term">River:</dt><dd class="searchresult-detail">{{ monitoringStation.riverName }}</dd>
                </div>
                <div class="searchresult-column">
                  <dt class="searchresult-term">Grid reference:</dt><dd class="searchresult-detail">{{ monitoringStation.gridReference }}</dd>
                </div>
              </dl>
            </div>
            <hr class="searchresult-separator">
          {% endfor %}
        {% endif %}

        {% if exactMatches.returnLogs %}
          {% for returnLog in exactMatches.returnLogs %}
            <hr class="searchresult-separator">
            <div class="searchresult-row">
              <dl class="searchresult-list">
                <div class="searchresult-column">
                  <dt class="searchresult-term-l">Return reference:</dt><dd class="searchresult-detail-l"><a class="searchresult-link" href="/system/return-logs?id={{ returnLog.id }}">{{ returnLog.returnReference }}</a></dd><p class="govuk-body-s govuk-!-margin-bottom-0">Exact match</p>
                </div>
                <div class="searchresult-column">
                  <dt class="searchresult-term">Licence returns:</dt><dd class="searchresult-detail"><a class="searchresult-link" href="/system/licences/{{ returnLog.licenceId }}/returns">{{ returnLog.licenceRef }}</a></dd>
                </div>
                <div class="searchresult-column">
                  <dt class="searchresult-term">End date:</dt><dd class="searchresult-detail">{{ returnLog.endDate }} {{ returnStatusTag(returnLog.statusText, true) if returnLog.statusText }}</dd>
                </div>
              </dl>
            </div>
            <hr class="searchresult-separator">
          {% endfor %}
        {% endif %}

        {% if exactMatches.users %}
          {% for user in exactMatches.users %}
            <hr class="searchresult-separator">
            <div class="searchresult-row">
              <dl class="searchresult-list">
                <div class="searchresult-column">
                  <dt class="searchresult-term-l">User:</dt><dd class="searchresult-detail-l"><a class="searchresult-link" href="/user/{{ user.id }}/status">{{ user.username }}</a></dd><p class="govuk-body-s govuk-!-margin-bottom-0">Exact match</p>
                </div>
                <div class="searchresult-column">
                  <dt class="searchresult-term">Type:</dt><dd class="searchresult-detail">{{ user.type }}</dd>
                </div>
                <div class="searchresult-column">
                  <dt class="searchresult-term">Last signed in:</dt><dd class="searchresult-detail">{{ user.lastLogin }}</dd>
                </div>
              </dl>
            </div>
            <hr class="searchresult-separator">
          {% endfor %}
        {% endif %}

      {% endif %}

      {% if not noPartialResults %}
        {% if partialMatches.licences %}
          {% for licence in partialMatches.licences %}
            <hr class="searchresult-separator">
            <div class="searchresult-row">
              <dl class="searchresult-list">
                <div class="searchresult-column">
                  <dt class="searchresult-term-l">Licence:</dt><dd class="searchresult-detail-l"><a class="searchresult-link" href="/system/licences/{{ licence.id }}/summary">{{ licence.licenceRef }}</a></dd>
                </div>
                <div class="searchresult-column">
                  <dt class="searchresult-term">Licence holder:</dt><dd class="searchresult-detail">{{ licence.licenceHolderName }}</dd>
                </div>
                <div class="searchresult-column">
                  <dt class="searchresult-term">End date:</dt><dd class="searchresult-detail">{{ licence.licenceEndDate }} {{ licenceStatusTag(licence.licenceEndedText) if licence.licenceEndedText }}</dd>
                </div>
              </dl>
            </div>
            <hr class="searchresult-separator">
          {% endfor %}
        {% endif %}

        {% if partialMatches.monitoringStations %}
          {% for monitoringStation in partialMatches.monitoringStations %}
            <hr class="searchresult-separator">
            <div class="searchresult-row">
              <dl class="searchresult-list">
                <div class="searchresult-column">
                  <dt class="searchresult-term-l">Monitoring station:</dt><dd class="searchresult-detail-l"><a class="searchresult-link" href="/system/monitoring-stations/{{ monitoringStation.id }}">{{ monitoringStation.label }}</a></dd>
                </div>
                <div class="searchresult-column">
                  <dt class="searchresult-term">River:</dt><dd class="searchresult-detail">{{ monitoringStation.riverName }}</dd>
                </div>
                <div class="searchresult-column">
                  <dt class="searchresult-term">Grid reference:</dt><dd class="searchresult-detail">{{ monitoringStation.gridReference }}</dd>
                </div>
              </dl>
            </div>
            <hr class="searchresult-separator">
          {% endfor %}
        {% endif %}

        {% if partialMatches.returnLogs %}
          {% for returnLog in partialMatches.returnLogs %}
            <hr class="searchresult-separator">
            <div class="searchresult-row">
              <dl class="searchresult-list">
                <div class="searchresult-column">
                  <dt class="searchresult-term-l">Return reference:</dt><dd class="searchresult-detail-l"><a class="searchresult-link" href="/system/return-logs?id={{ returnLog.id }}">{{ returnLog.returnReference }}</a></dd>
                </div>
                <div class="searchresult-column">
                  <dt class="searchresult-term">Licence returns:</dt><dd class="searchresult-detail"><a class="searchresult-link" href="/system/licences/{{ returnLog.licenceId }}/returns">{{ returnLog.licenceRef }}</a></dd>
                </div>
                <div class="searchresult-column">
                  <dt class="searchresult-term">End date:</dt><dd class="searchresult-detail">{{ returnLog.endDate }} {{ returnStatusTag(returnLog.statusText, true) if returnLog.statusText }}</dd>
                </div>
              </dl>
            </div>
            <hr class="searchresult-separator">
          {% endfor %}
        {% endif %}

        {% if partialMatches.users %}
          {% for user in partialMatches.users %}
            <hr class="searchresult-separator">
            <div class="searchresult-row">
              <dl class="searchresult-list">
                <div class="searchresult-column">
                  <dt class="searchresult-term-l">User:</dt><dd class="searchresult-detail-l"><a class="searchresult-link" href="/user/{{ user.id }}/status">{{ user.username }}</a></dd>
                </div>
                <div class="searchresult-column">
                  <dt class="searchresult-term">Type:</dt><dd class="searchresult-detail">{{ user.type }}</dd>
                </div>
                <div class="searchresult-column">
                  <dt class="searchresult-term">Last signed in:</dt><dd class="searchresult-detail">{{ user.lastLogin }}</dd>
                </div>
              </dl>
            </div>
            <hr class="searchresult-separator">
          {% endfor %}
        {% endif %}
      {% endif %}

      <hr class="searchresult-separator">

      {% if pagination.numberOfPages > 1 %}
        <div class="govuk-grid-row govuk-!-margin-top-9">
          <div class="govuk-grid-column-full">
            {{ govukPagination(pagination.component) }}
          </div>
        </div>
      {% endif %}

    {% endif %}
  {% endif %}

{% endblock %}
