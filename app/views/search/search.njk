{% extends 'layout.njk' %}

{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/details/macro.njk" import govukDetails %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/pagination/macro.njk" import govukPagination %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% from "govuk/components/tag/macro.njk" import govukTag %}

{% from "macros/return-status-tag.njk" import statusTag as returnStatusTag %}

{% macro licenceStatusTag(text) %}{{ govukTag({ text: text, classes: 'govuk-tag--grey' }) }}{% endmacro %}

{% macro statusTag(type, text) %}
  {{ licenceStatusTag(text) if type == 'Licence' }}
  {{ returnStatusTag(text, true) if type == 'Return reference' }}
{% endmacro %}

{% set filterContent %}
  <h2 class="govuk-heading-m govuk-!-margin-bottom-5">Filter matches by</h2>

  {{ govukRadios({
    classes: "govuk-radios--small",
    name: "resultType",
    fieldset: {
      legend: {
        text: "Match type",
        isPageHeading: false,
        classes: "govuk-fieldset__legend--s"
      }
    },
    items: filterItems
  }) }}

  <div class="govuk-button-group">
    {{ govukButton({
      preventDoubleClick: true,
      text: "Apply filter"
    }) }}

    {{ govukButton({
      classes: "govuk-button--secondary",
      name: "clearFilter",
      preventDoubleClick: true,
      text: "Clear filter",
      value: 'reset'
    }) }}
  </div>
{% endset %}

{% block pageContent %}

  <div class="govuk-grid-row govuk-!-margin-top-9">
    <div class="govuk-grid-column-full">
      <form method="post">
        <input type="hidden" name="wrlsCrumb" value="{{ wrlsCrumb }}"/>

        <div class="govuk-form-group {{ 'govuk-form-group--error' if error.query }}">
          <label class="govuk-label" for="query">
            Enter a licence number, customer name, returns ID, registered email address or monitoring station
          </label>

          {% if error.query %}
          <p id="query-error" class="govuk-error-message">
            <span class="govuk-visually-hidden">Error:</span> {{ error.query.text }}
          </p>
          {% endif %}
          <input class="govuk-input govuk-!-width-one-half govuk-!-display-inline-block" id="query" name="query" type="text" value="{{ query }}" {{ 'aria-describedby="query-hint query-error"' if error.query }}>

          {{ govukButton({
            classes: 'govuk-!-display-inline-block govuk-!-padding-right-6 govuk-!-padding-left-6',
            text: "Search", preventDoubleClick: true
          }) }}

          {{ govukDetails({
            classes: "govuk-!-margin-bottom-2",
            html: filterContent,
            open: resultType,
            summaryText: "Filter matches"
          }) }}
        </div>
      </form>
    </div>
  </div>

  {% if showResults %}
    {% if noResults %}
      <div class="govuk-grid-row govuk-!-margin-top-9">
        <div class="govuk-grid-column-full">
          <p>No results found.</p>
        </div>
      </div>
    {% else %}
      <p class="govuk-body govuk-!-font-weight-bold">{{ pagination.showingMessage }}</p>

      <hr class="searchresult-separator">

      {% for result in results %}
        <hr class="searchresult-separator">
        <div class="searchresult-row">
          <dl class="searchresult-list">
            <div class="searchresult-column">
              <dt class="searchresult-term-l">{{ result.type }}:</dt><dd class="searchresult-detail-l"><a class="searchresult-link" href="{{ result.link }}">{{ result.reference }}</a></dd>{% if result.exact %}<p class="govuk-body-s govuk-!-margin-bottom-0">Exact match</p>{% endif %}
            </div>
            <div class="searchresult-column">
              <dt class="searchresult-term">{{ result.col2Title }}:</dt><dd class="searchresult-detail">{{ result.col2Value }}</dd>
            </div>
            <div class="searchresult-column">
              <dt class="searchresult-term">{{ result.col3Title }}:</dt><dd class="searchresult-detail">{{ result.col3Value }} {{ statusTag(result.type, result.statusTag) if result.statusTag }}</dd>
            </div>
          </dl>
        </div>
        <hr class="searchresult-separator">
      {% endfor %}

      <hr class="searchresult-separator">

      {% if pagination.numberOfPages > 1 %}
        <div class="govuk-grid-row govuk-!-margin-top-9">
          <div class="govuk-grid-column-full">
            {{ govukPagination(pagination.component) }}
          </div>
        </div>
      {% endif %}

    {% endif %}
  {% endif %}

{% endblock %}
