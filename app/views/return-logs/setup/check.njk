{% extends 'layout.njk' %}

{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/inset-text/macro.njk" import govukInsetText %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{% from "govuk/components/table/macro.njk" import govukTable %}

{% block pageContent %}
  {{ pageHeadingHtml }}

  {{ govukSummaryList({
      classes: 'govuk-summary-list--no-border govuk-!-margin-bottom-9',
      attributes: {
        'data-test': 'meta-data'
      },
      rows: [
        {
          key: { text: "Site description", classes: "meta-data__label" },
          value: { text: siteDescription, classes: "meta-data__value", attributes: { 'data-test': 'site-description' } }
        },
        {
          key: { text: "Purpose", classes: "meta-data__label" },
          value: { text: purposes, classes: "meta-data__value", attributes: { 'data-test': 'purpose' } }
        },
        {
          key: { text: "Return period", classes: "meta-data__label" },
          value: { text: returnPeriod, classes: "meta-data__value", attributes: { 'data-test': 'returns-period' } }
        },
        {
          key: { text: "Abstraction period", classes: "meta-data__label" },
          value: { text: abstractionPeriod, classes: "meta-data__value", attributes: { 'data-test': 'abstraction-period' } }
        },
        {
          key: { text: "Tariff", classes: "meta-data__label" },
          value: { text: tariff, classes: "meta-data__value", attributes: { 'data-test': 'tariff' } }
        }
      ]
    })
  }}

  <div class="govuk-!-margin-bottom-9">
    <h2 class="govuk-heading-l govuk-!-margin-bottom-4">Notes</h2>
    <hr class="govuk-section-break--visible">
    <div class="govuk-summary-list govuk-!-margin-bottom-1">
      <p>{{ note.text | escape | nl2br }}</p>
      <span class="govuk-summary-list__actions">
        <ul class="govuk-summary-list__actions-list">
          {% for action in note.actions %}
            <li class="govuk-summary-list__actions-list-item">
              <a class="govuk-link" href="{{ action.href }}" data-test="{{ action.href }}">
                {{ action.text }} <span class="govuk-visually-hidden">the note</span>
              </a>
            </li>
          {% endfor %}
        </ul>
      </span>
    </div>
    <hr class="govuk-section-break--visible">
  </div>

  {% set meterDetails %}
    {% if meterProvided === 'yes' %}
      <ul class="govuk-list">
        <li class="govuk-!-margin-bottom-0">{{ meterMake }}</li>
        <li class="govuk-!-margin-bottom-0">{{ meterSerialNumber }}</li>
        {% if meter10TimesDisplay === 'yes' %}
          <li class="govuk-!-margin-bottom-0">Has &times;10 display</li>
        {% endif %}
      </ul>
    {% endif %}
  {% endset %}

  <div class="govuk-!-margin-bottom-9">
    {{ govukSummaryList({
      card: {
        title: { text: "Reporting details" }
      },
      rows: [
        {
          key: { text: "Return received" },
          value: { text: returnReceivedDate },
          actions: {
            items: [
              {
                href: links.received,
                text: "Change",
                visuallyHiddenText: "return received date"
              }
            ]
          }
        },
        {
          key: { text: "Nil return" },
          value: { text: nilReturn },
          actions: {
            items: [
              {
                href: links.nilReturn,
                text: "Change",
                visuallyHiddenText: "nil return"
              }
            ]
          }
        },
        {
          key: { text: "Reporting figures" },
          value: { text: reportingFigures },
          actions: {
            items: [
              {
                href: links.reported,
                text: "Change",
                visuallyHiddenText: "reporting figures"
              }
            ]
          }
        } if nilReturn === "No",
        {
          key: { text: "Start meter reading" },
          value: { text: startReading },
          actions: {
            items: [
              {
                href: links.startReading,
                text: "Change",
                visuallyHiddenText: "start meter reading"
              }
            ]
          }
        } if nilReturn === "No" and displayReadings,
        {
          key: { text: "Units" },
          value: { text: units },
          actions: {
            items: [
              {
                href: links.units,
                text: "Change",
                visuallyHiddenText: "unit of measure"
              }
            ]
          }
        } if nilReturn === "No",
        {
          key: { text: "Meter details" },
          value: { html: meterDetails },
          actions: {
            items: [
              {
                href: links.meterDetails,
                text: "Change",
                visuallyHiddenText: "meter details"
              }
            ]
          }
        } if nilReturn === "No"
      ]
    }) }}
  </div>

  {% if nilReturn === "No" %}
    <hr class="govuk-section-break govuk-section-break--l divider">

    {% set tableRows = [] %}

    {% for row in summaryTableData.rows %}
      {# Set an easier to use index #}
      {% set rowIndex = loop.index0 %}

      {% set tableRow = [
        {
          text: row.month,
          attributes: { 'data-test': 'month-' + rowIndex }
        }
      ] %}

      {% if displayReadings %}
        {% set tableRow = (tableRow.push(
          {
            text: row.reading,
            format: 'numeric',
            attributes: { 'data-test': 'reading-' + rowIndex }
          }
        ), tableRow) %}
      {% endif %}

      {% if displayUnits %}
        {% set tableRow = (tableRow.push(
          {
            text: row.unitTotal,
            format: 'numeric',
            attributes: { 'data-test': 'unit-total-' + rowIndex }
          }
        ), tableRow) %}
      {% endif %}

      {% set tableRow = (tableRow.push(
        {
          text: row.monthlyTotal,
          format: 'numeric',
          attributes: { 'data-test': 'monthly-total-' + rowIndex }
        }
      ), tableRow) %}

      {% if row.link %}
        {% set actionLink %}
          <a class="govuk-link" href="{{ row.link.href }}">{{ row.link.text }}<span class="govuk-visually-hidden"> for {{ row.month }}</span></a>
        {% endset %}

        {% set tableRow = (tableRow.push(
          {
            html: actionLink,
            format: 'numeric',
            attributes: { 'data-test': 'action-' + rowIndex }
          }
        ), tableRow) %}
      {% endif %}

      {% set tableRows = (tableRows.push(tableRow), tableRows) %}
    {% endfor %}

    {% set tableRow = [
      {
        text: "Total volume of water abstracted",
        classes: "govuk-table__header"
      }
    ] %}

    {% if displayReadings %}
      {% set tableRow = (tableRow.push(
        {
          text: ""
        }
      ), tableRow) %}
    {% endif %}

    {% if displayUnits %}
      {% set tableRow = (tableRow.push(
        {
          html: "<strong>" + totalQuantity + "</strong>",
          format: 'numeric',
          attributes: { 'data-test': 'total-quantity' }
        }
      ), tableRow) %}
    {% endif %}

    {% set tableRow = (tableRow.push(
      {
        html: "<strong>" + totalCubicMetres + "</strong>",
        format: 'numeric',
        attributes: { 'data-test': 'total-cubic-metres' }
      }
    ), tableRow) %}

    {% set tableRow = (tableRow.push(
      {
        text: ""
      }
    ), tableRow) %}

    {% set tableRows = (tableRows.push(tableRow), tableRows) %}

    <div class="govuk-grid-row govuk-!-margin-bottom-0">
      <div class="govuk-grid-column-full">
        <h2 class="govuk-heading-l">{{tableTitle}}</h2>
        <p class="govuk-!-margin-bottom-3">
          <strong><a class="govuk-link" href="{{links.multipleEntries}}">{{enterMultipleLinkText}}</a></strong> â€“ paste in values for an entire return period
        </p>

        {{ govukTable({
          firstCellIsHeader: false,
          attributes: { 'data-test': 'monthly-summaries'},
          head: summaryTableData.headers,
          rows: tableRows
        }) }}
      </div>
    </div>
  {% endif %}

  <form method="post">
    <input type="hidden" name="wrlsCrumb" value="{{wrlsCrumb}}"/>
    <div class="govuk-button-group">
      {{ govukButton({
        text: "Confirm",
        preventDoubleClick: true
      }) }}

      {{ govukButton({
        text: "Cancel",
        classes: "govuk-button--secondary",
        preventDoubleClick: true,
        href: links.cancel
      }) }}
    </div>
  </form>
{% endblock %}
