{% from "govuk/components/details/macro.njk" import govukDetails %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}

{% from "macros/new-line-array-items.njk" import newLineArrayItems %}

{% macro conditionsSummaryCards(conditionTypes, noConditionsMessage, showingConditions) -%}
  {% if conditionTypes.length === 0 %}
    <p>{{ noConditionsMessage }}</p>
  {% else %}

    {% if showingConditions %}
      <p> {{ showingConditions }} </p>
    {% endif %}

    {% for conditionType in conditionTypes %}
      {{ conditionsSummaryCard(conditionType) }}
    {% endfor %}
  {% endif %}

{%- endmacro %}

{% macro conditionsSummaryCard(conditionType) -%}
  {% set topAttr = 'condition-type-' + loop.index0 %}
  <div class="govuk-summary-card ">
    <div class="govuk-summary-card__title-wrapper ">
      <h2
        class="govuk-summary-card__title govuk-table__caption--m govuk-!-margin-bottom-0">{{ conditionType.displayTitle }}</h2>
    </div>

    <div class="govuk-summary-card__content govuk-!-padding-top-0">
      {% for condition in conditionType.conditions %}
        {% set conditionIndex = loop.index0 %}

        {{ govukSummaryList({
          classes: "govuk-summary-list--no-border",
          rows: [
            {
              key: {
              text: 'Subcode description',
              attributes: { 'data-test': topAttr + '-condition-' + conditionTypeIndex + '-subcode-description' }
            },
              value: {
              text: condition.subcodeDescription
            }
            },
            {
              key: {
              text: 'Condition type',
              attributes: { 'data-test': topAttr + '-condition-' + conditionTypeIndex + '-type' }
            },
              value: {
              text: condition.conditionType
            }
            },
            {
              key: {
              text: condition.param1.label,
              attributes: { 'data-test': topAttr + '-condition-' + conditionTypeIndex + '-param-1' }
            },
              value: {
              text: condition.param1.value
            }
            } if condition.param1,
            {
              key: {
              text: condition.param2.label,
              attributes: { 'data-test': topAttr + '-condition-' + conditionTypeIndex + '-param-2' }
            },
              value: {
              text: condition.param2.value
            }
            } if condition.param2,
            {
              key: {
              text: 'Other information',
              attributes: { 'data-test': topAttr + '-condition-' + conditionTypeIndex + '-other-information' }
            },
              value: {
              text: condition.otherInformation
            }
            },
            {
              key: {
              text: 'Purpose',
              attributes: { 'data-test': topAttr + '-condition-' + conditionTypeIndex + '-purpose' }
            },
              value: {
              text: condition.purpose
            }
            },
            {
              key: {
              text: condition.abstractionPoints.label,
              attributes: { 'data-test': topAttr + '-condition-' + conditionTypeIndex + '-points' }
            },
              value: {
              html: abstractionPointsCell(condition.abstractionPoints.descriptions, 'fella')
            }
            }
          ]
        }) }}

        {% if conditionIndex < conditionType.conditions.length - 1 %}
          <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">
        {% endif %}
      {% endfor %}
    </div>
  </div>
{%- endmacro %}

{% macro abstractionPointsCell(abstractionPoints, purposeDescription) %}
  {% if abstractionPoints.length > 5 %}
    {{ govukDetails({
      summaryText: "View your " + abstractionPoints.length + " abstraction points" | lower,
      html: newLineArrayItems(abstractionPoints) | safe,
      classes: "govuk-!-margin-bottom-0 govuk-!-padding-bottom-0 govuk-!-padding-top-0"
    }) }}
  {% else %}
    {{ newLineArrayItems(abstractionPoints) | safe }}
  {% endif %}
{% endmacro %}
