{% extends 'layout.njk' %}
{% from "govuk/components/back-link/macro.njk" import govukBackLink %}
{% from "govuk/components/details/macro.njk" import govukDetails %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{% from "govuk/components/table/macro.njk" import govukTable %}

{% macro newLine(array) %}
  {% for item in array %}
    <div class="govuk-!-margin-bottom-1"> {{ item }}</div>
  {% endfor %}
{% endmacro %}

{% macro abstractionPointCell(array, purposeDescription) %}
  {% set abstractionPoints %}
    {% for item in array %}
      {% if loop.last %}
        <div class="govuk-!-padding-top-1">{{ item }}</div>
      {% else %}
        <div class="govuk-!-padding-top-1 govuk-!-padding-bottom-1">{{ item }}</div>
      {% endif %}
    {% endfor %}
  {% endset %}

  {% if array.length > 5 %}
    {{ govukDetails({
      summaryText: "View your " + array.length + " abstraction points for " + purposeDescription | lower,
      html: abstractionPoints | safe,
      classes: "govuk-!-margin-bottom-0"
    }) }}
  {% else %}
    {{ abstractionPoints | safe }}
  {% endif %}
{% endmacro %}

{% block breadcrumbs %}
  {{ govukBackLink({
    text: 'Go back to summary',
    href: '/system/licences/' + id + '/summary'
  }) }}
{% endblock %}

{% block content %}
  <h1 class="govuk-heading-l">
    <span class="govuk-caption-l">Licence {{ licenceRef }}</span>
    {{ pageTitle }}
  </h1>

  {% for licencePurpose in licencePurposes %}
    {# Set an easier to use index. #}
    {% set rowIndex = loop.index0 %}

    {% set tableRows = [] %}

    {# Abstraction points cell #}
    {% set abstractionPointsRow =
      {
        key: {
          text: licencePurpose.abstractionPointsTitle,
          attributes: { 'data-test': 'abstraction-point-title-' + rowIndex },
          classes: "govuk-!-width-one-third"
        },
        value: {
          html: abstractionPointCell(licencePurpose.abstractionPoints, licencePurpose.purposeDescription),
          attributes: { 'data-test': 'abstraction-points-' + rowIndex }
        }
      }
    %}

    {% set tableRows = (tableRows.push(abstractionPointsRow), tableRows) %}

    {# Period of abstraction cell #}
    {% set abstractionPeriodRow =
      {
        key: {
          text: 'Period of abstraction',
          attributes: { 'data-test': 'abstraction-period-title-' + rowIndex }
        },
        value: {
          text: licencePurpose.abstractionPeriod,
          attributes: { 'data-test': 'abstraction-period-' + rowIndex }
        }
      }
    %}

    {% set tableRows = (tableRows.push(abstractionPeriodRow), tableRows) %}

    {# Abstraction amount cell #}
    {% if licencePurpose.abstractionAmounts.length > 0 %}
      {% set abstractionAmountsRow = {
        key: {
          text: licencePurpose.abstractionAmountsTitle,
          attributes: { 'data-test': 'abstraction-amount-title-' + rowIndex }
        },
        value: {
          text: newLine(licencePurpose.abstractionAmounts),
          attributes: { 'data-test': 'abstraction-amount-' + rowIndex }
        }
      } %}

      {% set tableRows = (tableRows.push(abstractionAmountsRow), tableRows) %}
    {% endif %}

    {# Summary card #}
    {{ govukSummaryList({
      card: {
        title: {
          text: licencePurpose.purposeDescription,
          classes: "govuk-table__caption--m govuk-!-margin-bottom-0"
        }
      },
      rows: tableRows
    }) }}

  {% endfor %}
{% endblock %}
