{% extends 'layout.njk' %}
{% from "govuk/components/back-link/macro.njk" import govukBackLink %}
{% from "govuk/components/notification-banner/macro.njk" import govukNotificationBanner %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/tabs/macro.njk" import govukTabs %}
{% from "govuk/components/warning-text/macro.njk" import govukWarningText %}

{% block breadcrumbs %}
  {{ govukBackLink({
    text: 'Go back to search',
    href: "/licences"
  }) }}
{% endblock %}

{% block content %}
  {% if warning %}
    {{ govukWarningText({
      text: warning,
      iconFallbackText: "Warning"
    }) }}
  {% endif %}

  {% if notification %}
    {% if notification %}
      {{ govukNotificationBanner({
        html: '<strong>' + notification + '</strong>'
      }) }}
    {% endif %}
  {% endif %}

  <span class="govuk-caption-l">{{ licenceName }}</span>
  <h1 class="govuk-heading-l">Licence number {{ licenceRef }}</h1>

  {% if registeredTo %}
    <p>Registered to <a href="/user/{{ primaryUser.userId }}/status">{{ registeredTo }}</a></p>
  {% endif %}

  {% if entries.length == 0 %}
    <p>No history for this licence.</p>
  {% else %}
    {% set tableRows = [] %}
    {% for entry in entries %}
      {# Set an easier to use index. Also means we can refer to it inside our elementDetail loop #}
      {% set rowIndex = loop.index0 %}

      {% set row = [
        {
          html: '<a href="' + entry.link + '">' + entry.type + '</a>',
          attributes: { 'data-test': 'entry-type-' + rowIndex }
        },
        {
          text: entry.reason,
          attributes: { 'data-test': 'entry-reason-' + rowIndex }
        },
        {
          text: entry.dateCreated,
          attributes: { 'data-test': 'entry-created-' + rowIndex }
        },
        {
          text: entry.createdBy,
          attributes: { 'data-test': 'entry-created-by-' + rowIndex }
        },
        {
          text: entry.note,
          attributes: { 'data-test': 'entry-note-' + rowIndex }
        }
      ] %}

      {% set tableRows = (tableRows.push(row), tableRows) %}
    {% endfor %}

    {{ govukTable({
      attributes: { 'data-test': 'bills-table' },
      caption: 'History',
      firstCellIsHeader: false,
      head: [
        { text: 'Type' },
        { text: 'Reason' },
        { text: 'Date created' },
        { text: 'Created by' },
        { text: 'Note' }
      ],
      rows: tableRows
    }) }}
  {% endif %}
{% endblock %}
